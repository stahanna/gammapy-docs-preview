
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "tutorials/starting/analysis_1.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_tutorials_starting_analysis_1.py>`
        to download the full example code or to run this example in your browser via Binder

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_tutorials_starting_analysis_1.py:


High level interface
====================

Introduction to 3D analysis using the Gammapy high level interface.

Prerequisites
-------------

-  Understanding the gammapy data workflow, in particular what are DL3
   events and instrument response functions (IRF).

Context
-------

This notebook is an introduction to gammapy analysis using the high
level interface.

Gammapy analysis consists in two main steps.

The first one is data reduction: user selected observations are reduced
to a geometry defined by the user. It can be 1D (spectrum from a given
extraction region) or 3D (with a sky projection and an energy axis). The
resulting reduced data and instrument response functions (IRF) are
called datasets in Gammapy.

The second step consists in setting a physical model on the datasets and
fitting it to obtain relevant physical information.

**Objective: Create a 3D dataset of the Crab using the H.E.S.S. DL3 data
release 1 and perform a simple model fitting of the Crab nebula.**

Proposed approach
-----------------

This notebook uses the high level `~gammapy.analysis.Analysis` class to orchestrate data
reduction. In its current state, `~gammapy.analysis.Analysis` supports the standard
analysis cases of joint or stacked 3D and 1D analyses. It is
instantiated with an `~gammapy.analysis.AnalysisConfig` object that gives access to
analysis parameters either directly or via a YAML config file.

To see what is happening under-the-hood and to get an idea of the
internal API, a second notebook performs the same analysis without using
the `~gammapy.analysis.Analysis` class.

In summary, we have to:

-  Create an `~gammapy.analysis.AnalysisConfig` object and edit it to
   define the analysis configuration:

   -  Define what observations to use
   -  Define the geometry of the dataset (data and IRFs)
   -  Define the model we want to fit on the dataset.

-  Instantiate a `~gammapy.analysis.Analysis` from this configuration
   and run the different analysis steps

   -  Observation selection
   -  Data reduction
   -  Model fitting
   -  Estimating flux points

Finally, we will compare the results against a reference model.

.. GENERATED FROM PYTHON SOURCE LINES 68-71

Setup
-----


.. GENERATED FROM PYTHON SOURCE LINES 71-79

.. code-block:: Python


    from pathlib import Path
    from astropy import units as u

    # %matplotlib inline
    import matplotlib.pyplot as plt
    from gammapy.analysis import Analysis, AnalysisConfig








.. GENERATED FROM PYTHON SOURCE LINES 80-82

Check setup
-----------

.. GENERATED FROM PYTHON SOURCE LINES 82-86

.. code-block:: Python

    from gammapy.utils.check import check_tutorials_setup

    check_tutorials_setup()





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

      0%|                                                                                                                                                                      | 0.00/152M [00:00<?, ?B/s]      0%|▌                                                                                                                                                             | 517k/152M [00:00<00:33, 4.70MB/s]      1%|█▎                                                                                                                                                           | 1.31M/152M [00:00<00:24, 6.38MB/s]      1%|██                                                                                                                                                           | 2.03M/152M [00:00<00:22, 6.87MB/s]      2%|██▉                                                                                                                                                          | 2.83M/152M [00:00<00:21, 7.44MB/s]      2%|███▊                                                                                                                                                         | 3.66M/152M [00:00<00:19, 7.86MB/s]      3%|████▌                                                                                                                                                        | 4.46M/152M [00:00<00:19, 8.01MB/s]      4%|█████▌                                                                                                                                                       | 5.34M/152M [00:00<00:18, 8.31MB/s]      4%|██████▍                                                                                                                                                      | 6.29M/152M [00:00<00:17, 8.82MB/s]      5%|███████▎                                                                                                                                                     | 7.14M/152M [00:00<00:17, 8.78MB/s]      5%|████████▎                                                                                                                                                    | 7.99M/152M [00:01<00:17, 8.77MB/s]      6%|█████████▎                                                                                                                                                   | 8.98M/152M [00:01<00:16, 9.22MB/s]      7%|██████████▎                                                                                                                                                  | 9.93M/152M [00:01<00:15, 9.43MB/s]      7%|███████████▏                                                                                                                                                 | 10.9M/152M [00:01<00:15, 9.51MB/s]      8%|████████████▏                                                                                                                                                | 11.8M/152M [00:01<00:15, 9.63MB/s]      8%|█████████████▏                                                                                                                                               | 12.8M/152M [00:01<00:14, 9.78MB/s]      9%|██████████████▍                                                                                                                                              | 14.0M/152M [00:01<00:13, 10.6MB/s]     10%|███████████████▋                                                                                                                                             | 15.2M/152M [00:01<00:13, 11.0MB/s]     11%|████████████████▊                                                                                                                                            | 16.3M/152M [00:01<00:12, 11.1MB/s]     12%|██████████████████▏                                                                                                                                          | 17.6M/152M [00:01<00:11, 11.8MB/s]     12%|███████████████████▍                                                                                                                                         | 18.8M/152M [00:02<00:11, 12.1MB/s]     13%|████████████████████▌                                                                                                                                        | 20.0M/152M [00:02<00:11, 12.1MB/s]     14%|█████████████████████▊                                                                                                                                       | 21.1M/152M [00:02<00:12, 11.4MB/s]     15%|███████████████████████▏                                                                                                                                     | 22.4M/152M [00:02<00:11, 12.0MB/s]     16%|████████████████████████▌                                                                                                                                    | 23.7M/152M [00:02<00:10, 12.6MB/s]     17%|█████████████████████████▉                                                                                                                                   | 25.1M/152M [00:02<00:10, 13.0MB/s]     17%|███████████████████████████▍                                                                                                                                 | 26.6M/152M [00:02<00:09, 13.6MB/s]     18%|████████████████████████████▊                                                                                                                                | 27.9M/152M [00:02<00:09, 13.4MB/s]     19%|██████████████████████████████                                                                                                                               | 29.2M/152M [00:02<00:09, 13.2MB/s]     20%|███████████████████████████████▍                                                                                                                             | 30.4M/152M [00:02<00:09, 13.1MB/s]     21%|████████████████████████████████▋                                                                                                                            | 31.7M/152M [00:03<00:10, 12.0MB/s]     22%|█████████████████████████████████▉                                                                                                                           | 32.8M/152M [00:03<00:11, 11.3MB/s]     22%|███████████████████████████████████                                                                                                                          | 33.9M/152M [00:03<00:10, 11.4MB/s]     23%|████████████████████████████████████▏                                                                                                                        | 35.0M/152M [00:03<00:10, 11.3MB/s]     24%|█████████████████████████████████████▎                                                                                                                       | 36.1M/152M [00:03<00:10, 11.2MB/s]     24%|██████████████████████████████████████▍                                                                                                                      | 37.2M/152M [00:03<00:11, 10.7MB/s]     25%|███████████████████████████████████████▍                                                                                                                     | 38.2M/152M [00:03<00:11, 10.3MB/s]     26%|████████████████████████████████████████▌                                                                                                                    | 39.2M/152M [00:03<00:11, 10.2MB/s]     26%|█████████████████████████████████████████▌                                                                                                                   | 40.2M/152M [00:04<00:12, 9.74MB/s]     27%|██████████████████████████████████████████▋                                                                                                                  | 41.3M/152M [00:04<00:11, 10.2MB/s]     28%|████████████████████████████████████████████                                                                                                                 | 42.7M/152M [00:04<00:09, 11.5MB/s]     29%|█████████████████████████████████████████████▍                                                                                                               | 44.0M/152M [00:04<00:09, 12.0MB/s]     30%|██████████████████████████████████████████████▋                                                                                                              | 45.2M/152M [00:04<00:09, 12.0MB/s]     31%|███████████████████████████████████████████████▉                                                                                                             | 46.4M/152M [00:04<00:09, 12.0MB/s]     31%|█████████████████████████████████████████████████                                                                                                            | 47.5M/152M [00:04<00:09, 11.9MB/s]     32%|██████████████████████████████████████████████████▎                                                                                                          | 48.7M/152M [00:04<00:08, 12.0MB/s]     33%|███████████████████████████████████████████████████▋                                                                                                         | 50.0M/152M [00:04<00:08, 12.4MB/s]     34%|████████████████████████████████████████████████████▉                                                                                                        | 51.2M/152M [00:04<00:08, 12.4MB/s]     34%|██████████████████████████████████████████████████████                                                                                                       | 52.4M/152M [00:05<00:08, 12.0MB/s]     35%|███████████████████████████████████████████████████████▎                                                                                                     | 53.5M/152M [00:05<00:08, 11.6MB/s]     36%|████████████████████████████████████████████████████████▍                                                                                                    | 54.7M/152M [00:05<00:08, 11.7MB/s]     37%|█████████████████████████████████████████████████████████▋                                                                                                   | 55.8M/152M [00:05<00:08, 11.6MB/s]     38%|██████████████████████████████████████████████████████████▉                                                                                                  | 57.0M/152M [00:05<00:08, 12.0MB/s]     38%|████████████████████████████████████████████████████████████▎                                                                                                | 58.4M/152M [00:05<00:07, 12.5MB/s]     39%|█████████████████████████████████████████████████████████████▊                                                                                               | 59.8M/152M [00:05<00:07, 13.0MB/s]     40%|███████████████████████████████████████████████████████████████▏                                                                                             | 61.2M/152M [00:05<00:07, 13.4MB/s]     41%|████████████████████████████████████████████████████████████████▌                                                                                            | 62.5M/152M [00:05<00:06, 13.6MB/s]     42%|█████████████████████████████████████████████████████████████████▉                                                                                           | 63.9M/152M [00:05<00:06, 13.7MB/s]     43%|███████████████████████████████████████████████████████████████████▎                                                                                         | 65.2M/152M [00:06<00:06, 13.8MB/s]     44%|████████████████████████████████████████████████████████████████████▋                                                                                        | 66.5M/152M [00:06<00:06, 13.6MB/s]     45%|██████████████████████████████████████████████████████████████████████                                                                                       | 67.9M/152M [00:06<00:06, 13.7MB/s]     45%|███████████████████████████████████████████████████████████████████████▍                                                                                     | 69.2M/152M [00:06<00:06, 13.6MB/s]     46%|████████████████████████████████████████████████████████████████████████▉                                                                                    | 70.6M/152M [00:06<00:06, 14.0MB/s]     47%|██████████████████████████████████████████████████████████████████████████▍                                                                                  | 72.0M/152M [00:06<00:05, 14.4MB/s]     48%|████████████████████████████████████████████████████████████████████████████                                                                                 | 73.7M/152M [00:06<00:05, 15.1MB/s]     50%|█████████████████████████████████████████████████████████████████████████████▉                                                                               | 75.5M/152M [00:06<00:04, 16.2MB/s]     51%|███████████████████████████████████████████████████████████████████████████████▊                                                                             | 77.3M/152M [00:06<00:04, 17.1MB/s]     52%|█████████████████████████████████████████████████████████████████████████████████▌                                                                           | 78.9M/152M [00:06<00:04, 16.9MB/s]     53%|███████████████████████████████████████████████████████████████████████████████████▏                                                                         | 80.6M/152M [00:07<00:04, 16.2MB/s]     54%|████████████████████████████████████████████████████████████████████████████████████▊                                                                        | 82.1M/152M [00:07<00:04, 16.1MB/s]     55%|██████████████████████████████████████████████████████████████████████████████████████▍                                                                      | 83.6M/152M [00:07<00:04, 15.4MB/s]     56%|███████████████████████████████████████████████████████████████████████████████████████▉                                                                     | 85.1M/152M [00:07<00:04, 14.8MB/s]     57%|█████████████████████████████████████████████████████████████████████████████████████████▌                                                                   | 86.7M/152M [00:07<00:04, 15.2MB/s]     58%|███████████████████████████████████████████████████████████████████████████████████████████                                                                  | 88.2M/152M [00:07<00:04, 15.3MB/s]     59%|████████████████████████████████████████████████████████████████████████████████████████████▋                                                                | 89.7M/152M [00:07<00:04, 15.5MB/s]     60%|██████████████████████████████████████████████████████████████████████████████████████████████▏                                                              | 91.2M/152M [00:07<00:04, 15.5MB/s]     61%|███████████████████████████████████████████████████████████████████████████████████████████████▊                                                             | 92.7M/152M [00:07<00:04, 15.3MB/s]     62%|█████████████████████████████████████████████████████████████████████████████████████████████████▎                                                           | 94.2M/152M [00:08<00:04, 15.1MB/s]     63%|██████████████████████████████████████████████████████████████████████████████████████████████████▊                                                          | 95.7M/152M [00:08<00:04, 14.5MB/s]     64%|████████████████████████████████████████████████████████████████████████████████████████████████████▎                                                        | 97.1M/152M [00:08<00:04, 12.1MB/s]     65%|█████████████████████████████████████████████████████████████████████████████████████████████████████▌                                                       | 98.3M/152M [00:08<00:05, 10.3MB/s]     65%|██████████████████████████████████████████████████████████████████████████████████████████████████████▌                                                      | 99.4M/152M [00:08<00:05, 9.30MB/s]     66%|████████████████████████████████████████████████████████████████████████████████████████████████████████▎                                                     | 100M/152M [00:08<00:06, 8.78MB/s]     67%|█████████████████████████████████████████████████████████████████████████████████████████████████████████▏                                                    | 101M/152M [00:08<00:06, 8.42MB/s]     67%|██████████████████████████████████████████████████████████████████████████████████████████████████████████                                                    | 102M/152M [00:09<00:06, 8.49MB/s]     68%|██████████████████████████████████████████████████████████████████████████████████████████████████████████▉                                                   | 103M/152M [00:09<00:06, 8.38MB/s]     68%|███████████████████████████████████████████████████████████████████████████████████████████████████████████▊                                                  | 104M/152M [00:09<00:06, 8.40MB/s]     69%|████████████████████████████████████████████████████████████████████████████████████████████████████████████▋                                                 | 105M/152M [00:09<00:05, 8.53MB/s]     69%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████▊                                                | 106M/152M [00:09<00:05, 9.27MB/s]     70%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████▉                                               | 107M/152M [00:09<00:04, 9.54MB/s]     71%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████▉                                              | 108M/152M [00:09<00:04, 9.81MB/s]     72%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████▉                                             | 109M/152M [00:09<00:04, 9.98MB/s]     72%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                                           | 110M/152M [00:09<00:04, 10.7MB/s]     73%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████▌                                          | 111M/152M [00:09<00:03, 11.3MB/s]     74%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▋                                         | 112M/152M [00:10<00:03, 11.4MB/s]     75%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▉                                        | 113M/152M [00:10<00:03, 11.5MB/s]     76%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                                      | 115M/152M [00:10<00:03, 12.4MB/s]     76%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▌                                     | 116M/152M [00:10<00:03, 11.8MB/s]     77%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊                                    | 117M/152M [00:10<00:03, 11.6MB/s]     78%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▉                                   | 118M/152M [00:10<00:03, 11.5MB/s]     79%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████                                  | 119M/152M [00:10<00:02, 11.4MB/s]     79%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▌                                | 121M/152M [00:10<00:02, 12.3MB/s]     80%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▉                               | 122M/152M [00:10<00:02, 12.8MB/s]     81%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                             | 123M/152M [00:10<00:02, 13.0MB/s]     82%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▋                            | 125M/152M [00:11<00:02, 13.3MB/s]     83%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████                           | 126M/152M [00:11<00:02, 13.3MB/s]     84%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                         | 127M/152M [00:11<00:01, 13.5MB/s]     85%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▋                        | 129M/152M [00:11<00:01, 13.5MB/s]     86%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                      | 130M/152M [00:11<00:01, 14.0MB/s]     87%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▋                     | 132M/152M [00:11<00:01, 14.3MB/s]     87%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▏                   | 133M/152M [00:11<00:01, 13.9MB/s]     88%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▌                  | 134M/152M [00:11<00:01, 13.4MB/s]     89%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▉                 | 136M/152M [00:11<00:01, 13.1MB/s]     90%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▏               | 137M/152M [00:12<00:01, 12.8MB/s]     91%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍              | 138M/152M [00:12<00:01, 12.8MB/s]     92%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████             | 140M/152M [00:12<00:00, 13.6MB/s]     93%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍           | 141M/152M [00:12<00:00, 12.6MB/s]     93%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▋          | 142M/152M [00:12<00:01, 10.4MB/s]     94%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊         | 143M/152M [00:12<00:01, 9.04MB/s]     95%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▋        | 144M/152M [00:12<00:00, 8.46MB/s]     95%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▋       | 145M/152M [00:12<00:00, 7.83MB/s]     96%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍      | 146M/152M [00:13<00:00, 7.68MB/s]     96%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▏     | 146M/152M [00:13<00:00, 7.32MB/s]     97%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▉     | 147M/152M [00:13<00:00, 6.69MB/s]     97%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▋    | 148M/152M [00:13<00:00, 6.42MB/s]     98%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▎   | 148M/152M [00:13<00:00, 6.40MB/s]     98%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████   | 149M/152M [00:13<00:00, 6.64MB/s]     99%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊  | 150M/152M [00:13<00:00, 6.91MB/s]     99%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▌ | 151M/152M [00:13<00:00, 7.08MB/s]    100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▎| 151M/152M [00:13<00:00, 7.35MB/s]    152MB [00:14, 7.77MB/s]                                                                                                                                                                                   153MB [00:14, 8.13MB/s]    154MB [00:14, 8.51MB/s]    155MB [00:14, 8.72MB/s]    156MB [00:14, 9.09MB/s]    157MB [00:14, 9.38MB/s]    158MB [00:14, 9.73MB/s]    159MB [00:14, 9.75MB/s]    160MB [00:14, 10.0MB/s]    161MB [00:15, 10.5MB/s]    162MB [00:15, 11.0MB/s]    163MB [00:15, 11.3MB/s]    165MB [00:15, 11.6MB/s]    166MB [00:15, 12.1MB/s]    167MB [00:15, 12.4MB/s]    168MB [00:15, 12.6MB/s]    170MB [00:15, 12.7MB/s]    171MB [00:15, 12.7MB/s]    172MB [00:15, 12.9MB/s]    173MB [00:16, 13.0MB/s]    175MB [00:16, 13.6MB/s]    176MB [00:16, 14.0MB/s]    178MB [00:16, 13.6MB/s]    179MB [00:16, 12.4MB/s]    180MB [00:16, 11.0MB/s]    181MB [00:16, 10.1MB/s]    182MB [00:16, 9.74MB/s]    183MB [00:16, 9.59MB/s]    184MB [00:17, 9.65MB/s]    185MB [00:17, 9.81MB/s]    186MB [00:17, 9.67MB/s]    187MB [00:17, 8.79MB/s]    188MB [00:17, 7.71MB/s]    189MB [00:17, 7.15MB/s]    189MB [00:17, 6.89MB/s]    190MB [00:17, 6.88MB/s]    191MB [00:18, 6.89MB/s]    191MB [00:18, 7.00MB/s]    192MB [00:18, 6.44MB/s]    193MB [00:18, 6.17MB/s]    193MB [00:18, 6.03MB/s]    194MB [00:18, 5.50MB/s]    194MB [00:18, 5.26MB/s]    195MB [00:18, 5.26MB/s]    195MB [00:18, 5.37MB/s]    196MB [00:19, 5.52MB/s]    197MB [00:19, 5.75MB/s]    197MB [00:19, 5.98MB/s]    198MB [00:19, 6.13MB/s]    199MB [00:19, 6.51MB/s]    199MB [00:19, 6.90MB/s]    200MB [00:19, 7.27MB/s]    201MB [00:19, 7.41MB/s]    202MB [00:19, 7.74MB/s]    203MB [00:19, 8.13MB/s]    203MB [00:20, 7.82MB/s]    204MB [00:20, 7.58MB/s]    205MB [00:20, 7.35MB/s]    206MB [00:20, 7.20MB/s]    206MB [00:20, 7.15MB/s]    207MB [00:20, 7.36MB/s]    208MB [00:20, 7.69MB/s]    209MB [00:20, 7.87MB/s]    210MB [00:20, 8.25MB/s]    210MB [00:21, 8.60MB/s]    211MB [00:21, 8.67MB/s]    212MB [00:21, 8.59MB/s]    213MB [00:21, 9.03MB/s]    214MB [00:21, 9.24MB/s]    215MB [00:21, 9.73MB/s]    216MB [00:21, 10.2MB/s]    217MB [00:21, 10.4MB/s]    218MB [00:21, 10.5MB/s]    219MB [00:21, 10.9MB/s]    220MB [00:22, 11.0MB/s]    222MB [00:22, 11.4MB/s]    223MB [00:22, 11.9MB/s]    223MB [00:22, 10.5MB/s]

    *** You might want to declare GAMMAPY_DATA as a global env variable
    export GAMMAPY_DATA=$PWD/gammapy-data/dev

    Or as part of your conda environment:
    conda env config vars set GAMMAPY_DATA=$PWD/gammapy-data/dev
    conda conda activate gammapy-dev


    System:

            python_executable      : /home/hstapel/PycharmProjects/projekt_gammapy/gammapy/.tox/build_docs/bin/python 
            python_version         : 3.9.18     
            machine                : x86_64     
            system                 : Linux      


    Gammapy package:

            version                : 1.2.dev2111+g5675db08b.d20240402 
            path                   : /home/hstapel/PycharmProjects/projekt_gammapy/gammapy/.tox/build_docs/lib/python3.9/site-packages/gammapy 


    Other packages:

            numpy                  : 1.26.4     
            scipy                  : 1.12.0     
            astropy                : 5.2.2      
            regions                : 0.8        
            click                  : 8.1.7      
            yaml                   : 6.0.1      
            IPython                : 8.18.1     
            jupyterlab             : not installed 
            matplotlib             : 3.8.3      
            pandas                 : not installed 
            healpy                 : 1.16.6     
            iminuit                : 2.25.2     
            sherpa                 : 4.16.0     
            naima                  : 0.10.0     
            emcee                  : 3.1.4      
            corner                 : 2.2.2      
            ray                    : 2.10.0     


    Gammapy environment variables:

            GAMMAPY_DATA           : ./gammapy-data 





.. GENERATED FROM PYTHON SOURCE LINES 87-99

Analysis configuration
----------------------

For configuration of the analysis we use the
`YAML <https://en.wikipedia.org/wiki/YAML>`__ data format. YAML is a
machine readable serialisation format, that is also friendly for humans
to read. In this tutorial we will write the configuration file just
using Python strings, but of course the file can be created and modified
with any text editor of your choice.

Here is what the configuration for our analysis looks like:


.. GENERATED FROM PYTHON SOURCE LINES 99-105

.. code-block:: Python


    config = AnalysisConfig()
    # the AnalysisConfig gives access to the various parameters used from logging to reduced dataset geometries
    print(config)






.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    AnalysisConfig

        general:
            log: {level: info, filename: null, filemode: null, format: null, datefmt: null}
            outdir: .
            n_jobs: 1
            datasets_file: null
            models_file: null
        observations:
            datastore: $GAMMAPY_DATA/hess-dl3-dr1
            obs_ids: []
            obs_file: null
            obs_cone: {frame: null, lon: null, lat: null, radius: null}
            obs_time: {start: null, stop: null}
            required_irf: [aeff, edisp, psf, bkg]
        datasets:
            type: 1d
            stack: true
            geom:
                wcs:
                    skydir: {frame: null, lon: null, lat: null}
                    binsize: 0.02 deg
                    width: {width: 5.0 deg, height: 5.0 deg}
                    binsize_irf: 0.2 deg
                selection: {offset_max: 2.5 deg}
                axes:
                    energy: {min: 1.0 TeV, max: 10.0 TeV, nbins: 5}
                    energy_true: {min: 0.5 TeV, max: 20.0 TeV, nbins: 16}
            map_selection: [counts, exposure, background, psf, edisp]
            background:
                method: null
                exclusion: null
                parameters: {}
            safe_mask:
                methods: [aeff-default]
                parameters: {}
            on_region: {frame: null, lon: null, lat: null, radius: null}
            containment_correction: true
        fit:
            fit_range: {min: null, max: null}
        flux_points:
            energy: {min: null, max: null, nbins: null}
            source: source
            parameters: {selection_optional: all}
        excess_map:
            correlation_radius: 0.1 deg
            parameters: {}
            energy_edges: {min: null, max: null, nbins: null}
        light_curve:
            time_intervals: {start: null, stop: null}
            energy_edges: {min: null, max: null, nbins: null}
            source: source
            parameters: {selection_optional: all}
    




.. GENERATED FROM PYTHON SOURCE LINES 106-109

Setting the data to use
~~~~~~~~~~~~~~~~~~~~~~~


.. GENERATED FROM PYTHON SOURCE LINES 112-120

We want to use Crab runs from the H.E.S.S. DL3-DR1. We define here the
datastore and a cone search of observations pointing with 5 degrees of
the Crab nebula. Parameters can be set directly or as a python dict.

PS: do not forget to setup your environment variable `$GAMMAPY_DATA` to
your local directory containing the H.E.S.S. DL3-DR1 as described in
:ref:`quickstart-setup`.


.. GENERATED FROM PYTHON SOURCE LINES 120-134

.. code-block:: Python


    # We define the datastore containing the data
    config.observations.datastore = "$GAMMAPY_DATA/hess-dl3-dr1"

    # We define the cone search parameters
    config.observations.obs_cone.frame = "icrs"
    config.observations.obs_cone.lon = "83.633 deg"
    config.observations.obs_cone.lat = "22.014 deg"
    config.observations.obs_cone.radius = "5 deg"

    # Equivalently we could have set parameters with a python dict
    # config.observations.obs_cone = {"frame": "icrs", "lon": "83.633 deg", "lat": "22.014 deg", "radius": "5 deg"}









.. GENERATED FROM PYTHON SOURCE LINES 135-138

Setting the reduced datasets geometry
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~


.. GENERATED FROM PYTHON SOURCE LINES 138-164

.. code-block:: Python


    # We want to perform a 3D analysis
    config.datasets.type = "3d"
    # We want to stack the data into a single reduced dataset
    config.datasets.stack = True

    # We fix the WCS geometry of the datasets
    config.datasets.geom.wcs.skydir = {
        "lon": "83.633 deg",
        "lat": "22.014 deg",
        "frame": "icrs",
    }
    config.datasets.geom.wcs.width = {"width": "2 deg", "height": "2 deg"}
    config.datasets.geom.wcs.binsize = "0.02 deg"

    # We now fix the energy axis for the counts map
    config.datasets.geom.axes.energy.min = "1 TeV"
    config.datasets.geom.axes.energy.max = "10 TeV"
    config.datasets.geom.axes.energy.nbins = 10

    # We now fix the energy axis for the IRF maps (exposure, etc)
    config.datasets.geom.axes.energy_true.min = "0.5 TeV"
    config.datasets.geom.axes.energy_true.max = "20 TeV"
    config.datasets.geom.axes.energy_true.nbins = 20









.. GENERATED FROM PYTHON SOURCE LINES 165-168

Setting the background normalization maker
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~


.. GENERATED FROM PYTHON SOURCE LINES 168-173

.. code-block:: Python


    config.datasets.background.method = "fov_background"
    config.datasets.background.parameters = {"method": "scale"}









.. GENERATED FROM PYTHON SOURCE LINES 174-177

Setting the exclusion mask
~~~~~~~~~~~~~~~~~~~~~~~~~~


.. GENERATED FROM PYTHON SOURCE LINES 180-185

In order to properly adjust the background normalisation on regions
without gamma-ray signal, one needs to define an exclusion mask for the
background normalisation. For this tutorial, we use the following one
``$GAMMAPY_DATA/joint-crab/exclusion/exclusion_mask_crab.fits.gz``


.. GENERATED FROM PYTHON SOURCE LINES 185-191

.. code-block:: Python


    config.datasets.background.exclusion = (
        "$GAMMAPY_DATA/joint-crab/exclusion/exclusion_mask_crab.fits.gz"
    )









.. GENERATED FROM PYTHON SOURCE LINES 192-203

Setting modeling and fitting parameters
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

``Analysis`` can perform a few modeling and fitting tasks besides data
reduction. Parameters have then to be passed to the configuration
object.

Here we define the energy range on which to perform the fit. We also set
the energy edges used for flux point computation as well as the
correlation radius to compute excess and significance maps.


.. GENERATED FROM PYTHON SOURCE LINES 203-210

.. code-block:: Python


    config.fit.fit_range.min = 1 * u.TeV
    config.fit.fit_range.max = 10 * u.TeV
    config.flux_points.energy = {"min": "1 TeV", "max": "10 TeV", "nbins": 4}
    config.excess_map.correlation_radius = 0.1 * u.deg









.. GENERATED FROM PYTHON SOURCE LINES 211-214

We’re all set. But before we go on let’s see how to save or import
``AnalysisConfig`` objects though YAML files.


.. GENERATED FROM PYTHON SOURCE LINES 217-222

Using YAML configuration files
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

One can export/import the `~gammapy.modeling.AnalysisConfig` to/from a YAML file.


.. GENERATED FROM PYTHON SOURCE LINES 222-229

.. code-block:: Python


    config.write("config.yaml", overwrite=True)

    config = AnalysisConfig.read("config.yaml")
    print(config)






.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    AnalysisConfig

        general:
            log: {level: info, filename: null, filemode: null, format: null, datefmt: null}
            outdir: .
            n_jobs: 1
            datasets_file: null
            models_file: null
        observations:
            datastore: gammapy-data/hess-dl3-dr1
            obs_ids: []
            obs_file: null
            obs_cone: {frame: icrs, lon: 83.633 deg, lat: 22.014 deg, radius: 5.0 deg}
            obs_time: {start: null, stop: null}
            required_irf: [aeff, edisp, psf, bkg]
        datasets:
            type: 3d
            stack: true
            geom:
                wcs:
                    skydir: {frame: icrs, lon: 83.633 deg, lat: 22.014 deg}
                    binsize: 0.02 deg
                    width: {width: 2.0 deg, height: 2.0 deg}
                    binsize_irf: 0.2 deg
                selection: {offset_max: 2.5 deg}
                axes:
                    energy: {min: 1.0 TeV, max: 10.0 TeV, nbins: 10}
                    energy_true: {min: 0.5 TeV, max: 20.0 TeV, nbins: 20}
            map_selection: [counts, exposure, background, psf, edisp]
            background:
                method: fov_background
                exclusion: gammapy-data/joint-crab/exclusion/exclusion_mask_crab.fits.gz
                parameters: {method: scale}
            safe_mask:
                methods: [aeff-default]
                parameters: {}
            on_region: {frame: null, lon: null, lat: null, radius: null}
            containment_correction: true
        fit:
            fit_range: {min: 1.0 TeV, max: 10.0 TeV}
        flux_points:
            energy: {min: 1.0 TeV, max: 10.0 TeV, nbins: 4}
            source: source
            parameters: {selection_optional: all}
        excess_map:
            correlation_radius: 0.1 deg
            parameters: {}
            energy_edges: {min: null, max: null, nbins: null}
        light_curve:
            time_intervals: {start: null, stop: null}
            energy_edges: {min: null, max: null, nbins: null}
            source: source
            parameters: {selection_optional: all}
    




.. GENERATED FROM PYTHON SOURCE LINES 230-236

Running the analysis
--------------------

We first create an `~gammapy.analysis.Analysis` object from our
configuration.


.. GENERATED FROM PYTHON SOURCE LINES 236-240

.. code-block:: Python


    analysis = Analysis(config)






.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Setting logging config: {'level': 'INFO', 'filename': None, 'filemode': None, 'format': None, 'datefmt': None}




.. GENERATED FROM PYTHON SOURCE LINES 241-247

Observation selection
~~~~~~~~~~~~~~~~~~~~~

We can directly select and load the observations from disk using
`~gammapy.analysis.Analysis.get_observations()`:


.. GENERATED FROM PYTHON SOURCE LINES 247-251

.. code-block:: Python


    analysis.get_observations()




.. rst-class:: sphx-glr-script-out

.. code-block:: pytb

    Traceback (most recent call last):
      File "/home/hstapel/PycharmProjects/projekt_gammapy/gammapy/examples/tutorials/starting/analysis_1.py", line 248, in <module>
        analysis.get_observations()
      File "/home/hstapel/PycharmProjects/projekt_gammapy/gammapy/.tox/build_docs/lib/python3.9/site-packages/gammapy/analysis/core.py", line 141, in get_observations
        self._set_data_store()
      File "/home/hstapel/PycharmProjects/projekt_gammapy/gammapy/.tox/build_docs/lib/python3.9/site-packages/gammapy/analysis/core.py", line 100, in _set_data_store
        raise FileNotFoundError(f"Datastore not found: {path}")
    FileNotFoundError: Datastore not found: gammapy-data/hess-dl3-dr1




.. GENERATED FROM PYTHON SOURCE LINES 252-255

The observations are now available on the `~gammapy.modeling.Analysis` object. The
selection corresponds to the following ids:


.. GENERATED FROM PYTHON SOURCE LINES 255-259

.. code-block:: Python


    print(analysis.observations.ids)



.. GENERATED FROM PYTHON SOURCE LINES 260-264

To see how to explore observations, please refer to the following
notebook: :doc:`CTA with Gammapy </tutorials/data/cta>` or :doc:`HESS with
Gammapy </tutorials/data/hess>`


.. GENERATED FROM PYTHON SOURCE LINES 267-274

Data reduction
--------------

Now we proceed to the data reduction. In the config file we have chosen
a WCS map geometry, energy axis and decided to stack the maps. We can
run the reduction using `~gammapy.modeling.Analysis.get_datasets()`:


.. GENERATED FROM PYTHON SOURCE LINES 276-279

.. code-block:: Python

    analysis.get_datasets()



.. GENERATED FROM PYTHON SOURCE LINES 280-283

As we have chosen to stack the data, there is finally one dataset
contained which we can print:


.. GENERATED FROM PYTHON SOURCE LINES 283-287

.. code-block:: Python


    print(analysis.datasets["stacked"])



.. GENERATED FROM PYTHON SOURCE LINES 288-294

As you can see the dataset comes with a predefined background model out
of the data reduction, but no source model has been set yet.

The counts, exposure and background model maps are directly available on
the dataset and can be printed and plotted:


.. GENERATED FROM PYTHON SOURCE LINES 294-299

.. code-block:: Python


    counts = analysis.datasets["stacked"].counts
    counts.smooth("0.05 deg").plot_interactive()



.. GENERATED FROM PYTHON SOURCE LINES 300-304

We can also compute the map of the sqrt_ts (significance) of the excess
counts above the background. The correlation radius to sum counts is
defined in the config file.


.. GENERATED FROM PYTHON SOURCE LINES 304-309

.. code-block:: Python


    analysis.get_excess_map()
    analysis.excess_map["sqrt_ts"].plot(add_cbar=True)
    plt.show()


.. GENERATED FROM PYTHON SOURCE LINES 310-317

Save dataset to disk
--------------------

It is common to run the preparation step independent of the likelihood
fit, because often the preparation of maps, PSF and energy dispersion is
slow if you have a lot of data. We first create a folder:


.. GENERATED FROM PYTHON SOURCE LINES 317-322

.. code-block:: Python


    path = Path("analysis_1")
    path.mkdir(exist_ok=True)



.. GENERATED FROM PYTHON SOURCE LINES 323-326

And then write the maps and IRFs to disk by calling the dedicated
`~gammapy.datasets.Datasets.write` method:


.. GENERATED FROM PYTHON SOURCE LINES 326-331

.. code-block:: Python


    filename = path / "crab-stacked-dataset.fits.gz"
    analysis.datasets[0].write(filename, overwrite=True)



.. GENERATED FROM PYTHON SOURCE LINES 332-338

Model fitting
-------------

Now we define a model to be fitted to the dataset. Here we use its YAML
definition to load it:


.. GENERATED FROM PYTHON SOURCE LINES 338-369

.. code-block:: Python


    model_config = """
    components:
    - name: crab
      type: SkyModel
      spatial:
        type: PointSpatialModel
        frame: icrs
        parameters:
        - name: lon_0
          value: 83.63
          unit: deg
        - name: lat_0
          value: 22.014
          unit: deg
      spectral:
        type: PowerLawSpectralModel
        parameters:
        - name: amplitude
          value: 1.0e-12
          unit: cm-2 s-1 TeV-1
        - name: index
          value: 2.0
          unit: ''
        - name: reference
          value: 1.0
          unit: TeV
          frozen: true
    """



.. GENERATED FROM PYTHON SOURCE LINES 370-372

Now we set the model on the analysis object:


.. GENERATED FROM PYTHON SOURCE LINES 372-376

.. code-block:: Python


    analysis.set_models(model_config)



.. GENERATED FROM PYTHON SOURCE LINES 377-379

Finally we run the fit:


.. GENERATED FROM PYTHON SOURCE LINES 381-386

.. code-block:: Python

    analysis.run_fit()

    print(analysis.fit_result)



.. GENERATED FROM PYTHON SOURCE LINES 387-389

This is how we can write the model back to file again:


.. GENERATED FROM PYTHON SOURCE LINES 389-397

.. code-block:: Python


    filename = path / "model-best-fit.yaml"
    analysis.models.write(filename, overwrite=True)

    with filename.open("r") as f:
        print(f.read())



.. GENERATED FROM PYTHON SOURCE LINES 398-401

Flux points
~~~~~~~~~~~


.. GENERATED FROM PYTHON SOURCE LINES 401-421

.. code-block:: Python


    analysis.config.flux_points.source = "crab"
    # Example showing how to change the FluxPointsEstimator parameters:
    analysis.config.flux_points.energy.nbins = 5
    config_dict = {
        "selection_optional": "all",
        "n_sigma": 2,  # Number of sigma to use for asymmetric error computation
        "n_sigma_ul": 3,  # Number of sigma to use for upper limit computation
    }
    analysis.config.flux_points.parameters = config_dict

    analysis.get_flux_points()

    # Example showing how to change just before plotting the threshold on the signal significance
    # (points vs upper limits), even if this has no effect with this data set.
    fp = analysis.flux_points.data
    fp.sqrt_ts_threshold_ul = 5
    ax_sed, ax_residuals = analysis.flux_points.plot_fit()
    plt.show()


.. GENERATED FROM PYTHON SOURCE LINES 422-426

The flux points can be exported to a fits table following the format
defined
`here <https://gamma-astro-data-formats.readthedocs.io/en/latest/spectra/flux_points/index.html>`_


.. GENERATED FROM PYTHON SOURCE LINES 426-431

.. code-block:: Python


    filename = path / "flux-points.fits"
    analysis.flux_points.write(filename, overwrite=True)



.. GENERATED FROM PYTHON SOURCE LINES 432-435

To check the fit is correct, we compute the map of the sqrt_ts of the
excess counts above the current model.


.. GENERATED FROM PYTHON SOURCE LINES 435-441

.. code-block:: Python


    analysis.get_excess_map()
    analysis.excess_map["sqrt_ts"].plot(add_cbar=True, cmap="RdBu", vmin=-5, vmax=5)
    plt.show()



.. GENERATED FROM PYTHON SOURCE LINES 442-451

What’s next
-----------

You can look at the same analysis without the high level interface in
:doc:`/tutorials/starting/analysis_2`

You can see how to perform a 1D spectral analysis of the same data in
:doc:`/tutorials/analysis-1d/spectral_analysis`



.. rst-class:: sphx-glr-timing

   **Total running time of the script:** (0 minutes 29.340 seconds)


.. _sphx_glr_download_tutorials_starting_analysis_1.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example

    .. container:: binder-badge

      .. image:: images/binder_badge_logo.svg
        :target: https://mybinder.org/v2/gh/gammapy/gammapy-webpage/master?urlpath=lab/tree/notebooks/dev/tutorials/starting/analysis_1.ipynb
        :alt: Launch binder
        :width: 150 px

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: analysis_1.ipynb <analysis_1.ipynb>`

    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: analysis_1.py <analysis_1.py>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
